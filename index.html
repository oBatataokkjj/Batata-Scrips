<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagina</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Tema Roxo - Cores principais */
        body {
            font-family: Arial, sans-serif;
            background-color: #2E0A47; /* Roxo escuro */
            color: #F1F1F1; /* Cor clara de texto */
        }

        /* Cabeçalho */
        .header {
            background-color: #4B1D69; /* Roxo mais claro */
            padding: 20px;
            text-align: center;
            color: #F1F1F1;
        }

        /* Cartões de crédito */
        .credit-card {
            background-color: #3B0A50; /* Roxo escuro */
            color: #F1F1F1;
            border-radius: 10px;
            padding: 20px;
            margin: 15px;
            width: 250px;
            display: inline-block;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
        }

        .credit-card:hover {
            transform: translateY(-5px);
        }

        .credit-name {
            font-weight: bold;
            font-size: 18px;
            color: #F1F1F1;
        }

        .credit-img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-bottom: 10px;
        }

        /* Modal */
        .modal-content {
            background-color: #4B1D69; /* Roxo mais claro */
            color: #F1F1F1;
            border-radius: 10px;
            padding: 20px;
        }

        /* Lista de Doações */
        .donation-item {
            background-color: #3B0A50;
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 8px;
            transition: transform 0.2s ease;
        }

        .donation-item:hover {
            transform: translateY(-5px);
        }

        .donation-header {
            display: flex;
            justify-content: space-between;
        }

        .donation-name {
            font-weight: bold;
            color: #F1F1F1;
        }

        .donation-amount {
            color: #F1F1F1;
        }

        /* Tabs de doações */
        .donations-tab {
            background-color: #4B1D69;
            padding: 10px;
            color: #F1F1F1;
            cursor: pointer;
            display: inline-block;
            border-radius: 5px;
            margin: 5px;
        }

        .donations-tab.active {
            background-color: #9B4DE3; /* Roxo mais claro */
        }

        .donation-empty {
            color: #F1F1F1;
            text-align: center;
        }

        .donation-loading {
            text-align: center;
            color: #F1F1F1;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #9B4DE3;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Botoes */
        .close-modal {
            background-color: #9B4DE3;
            color: #F1F1F1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        .close-modal:hover {
            background-color: #6A2E93;
        }
    </style>
</head>
<body>
    <!-- Cabeçalho -->
    <div class="header">
        <h1>Bem-vindo ao nosso site</h1>
    </div>

    <!-- Conteúdo dos cartões de crédito -->
    <div id="owners-container"></div>
    <div id="coleaders-container"></div>
    <div id="developers-container"></div>

    <!-- Abas de doações -->
    <div class="donations-tabs">
        <div class="donations-tab active" data-tab="recent">Doações Recentes</div>
        <div class="donations-tab" data-tab="ranking">Ranking de Doações</div>
    </div>

    <div id="donations-list"></div>

    <!-- Modal -->
    <div id="user-modal" class="modal">
        <div class="modal-content">
            <h2>Informações do usuário</h2>
            <button class="close-modal">Fechar</button>
        </div>
    </div>

    <script>
        async function createCreditCard(userId, userName) {
            const creditCard = document.createElement("div");
            creditCard.className = "credit-card";
            creditCard.setAttribute("data-aos", "zoom-in");
            creditCard.setAttribute("data-user-id", userId);

            const loadingDiv = document.createElement("div");
            loadingDiv.className = "loading-spinner";
            const spinner = document.createElement("div");
            spinner.className = "spinner";
            loadingDiv.appendChild(spinner);
            creditCard.appendChild(loadingDiv);

            const nameDiv = document.createElement("div");
            nameDiv.className = "credit-name";
            nameDiv.textContent = userName;
            creditCard.appendChild(nameDiv);

            const avatarUrl = await fetchDiscordAvatar(userId);

            creditCard.removeChild(loadingDiv);

            const img = document.createElement("img");
            img.className = "credit-img";
            img.alt = userName;

            if (avatarUrl) {
                img.src = avatarUrl;
            } else {
                img.src = "https://i.imgur.com/wubcMzk.jpeg";
            }

            creditCard.insertBefore(img, nameDiv);

            creditCard.addEventListener('click', function () {
                openUserModal(userId, userName, img.src);
            });

            return creditCard;
        }

        async function loadCreditCards() {
            const ownersContainer = document.getElementById("owners-container");
            for (const user of owners) {
                const card = await createCreditCard(user.id, user.name);
                ownersContainer.appendChild(card);
            }

            const coLeadersContainer = document.getElementById("coleaders-container");
            for (const user of coLeaders) {
                const card = await createCreditCard(user.id, user.name);
                coLeadersContainer.appendChild(card);
            }

            const developersContainer = document.getElementById("developers-container");
            for (const user of developers) {
                const card = await createCreditCard(user.id, user.name);
                developersContainer.appendChild(card);
            }
        }

        function formatarData(dataString) {
            const data = new Date(dataString);
            const agora = new Date();
            const diffMilissegundos = agora - data;
            const diffMinutos = Math.floor(diffMilissegundos / (1000 * 60));
            const diffHoras = Math.floor(diffMinutos / 60);
            const diffDias = Math.floor(diffHoras / 24);

            if (diffMinutos < 1) {
                return "agora mesmo";
            } else if (diffMinutos < 60) {
                return `há ${diffMinutos} ${diffMinutos === 1 ? 'minuto' : 'minutos'}`;
            } else if (diffHoras < 24) {
                return `há ${diffHoras} ${diffHoras === 1 ? 'hora' : 'horas'}`;
            } else if (diffDias < 30) {
                return `há ${diffDias} ${diffDias === 1 ? 'dia' : 'dias'}`;
            } else {
                const dia = data.getDate().toString().padStart(2, '0');
                const mes = (data.getMonth() + 1).toString().padStart(2, '0');
                const ano = data.getFullYear();
                return `${dia}/${mes}/${ano}`;
            }
        }

        function formatarValor(valor) {
            return 'R$ ' + valor.toFixed(2).replace('.', ',');
        }

        let currentTab = 'recent';
        let donationsData = [];

        function switchTab(tab) {
            currentTab = tab;
            const tabs = document.querySelectorAll('.donations-tab');
            tabs.forEach(t => t.classList.remove('active'));
            document.querySelector(`.donations-tab[data-tab="${tab}"]`).classList.add('active');
            renderDonations();
        }

        function renderDonations() {
            const doacoesList = document.getElementById('donations-list');

            if (donationsData.length === 0) {
                doacoesList.innerHTML = '<div class="donations-empty">Nenhuma doação encontrada.</div>';
                return;
            }

            doacoesList.innerHTML = '';

            if (currentTab === 'recent') {
                renderRecentDonations(doacoesList);
            } else {
                renderRankingDonations(doacoesList);
            }
        }

        function renderRecentDonations(container) {
            const recentes = donationsData.slice(0, 5);

            recentes.forEach(doacao => {
                const doacaoItem = document.createElement('div');
                doacaoItem.className = 'donation-item';
                doacaoItem.innerHTML = `
                    <div class="donation-header">
                        <div class="donation-name">${doacao.donatorNickname}</div>
                        <div class="donation-amount">${formatarValor(doacao.totalAmount)}</div>
                    </div>
                    <div class="donation-message">${doacao.donatorMessage || 'Sem mensagem'}</div>
                    <div class="donation-date">${formatarData(doacao.dateCreated)}</div>
                `;
                container.appendChild(doacaoItem);
            });
        }

        function renderRankingDonations(container) {
            const mesAtual = new Date().getMonth();
            const anoAtual = new Date().getFullYear();

            const doacoesMes = donationsData
                .filter(doacao => {
                    const data = new Date(doacao.dateCreated);
                    return data.getMonth() === mesAtual &&
                        data.getFullYear() === anoAtual;
                })
                .sort((a, b) => b.totalAmount - a.totalAmount)
                .slice(0, 5);

            if (doacoesMes.length === 0) {
                container.innerHTML = '<div class="donations-empty">Nenhuma doação este mês.</div>';
                return;
            }

            doacoesMes.forEach((doacao, index) => {
                const doacaoItem = document.createElement('div');
                doacaoItem.className = `donation-item rank-${index + 1}`;
                doacaoItem.innerHTML = `
                    <div class="donation-rank">
                        <div class="rank-number">${index + 1}</div>
                        <div class="donation-name">${doacao.donatorNickname}</div>
                        <div class="donation-amount">${formatarValor(doacao.totalAmount)}</div>
                    </div>
                    <div class="donation-message">${doacao.donatorMessage || 'Sem mensagem'}</div>
                    <div class="donation-date">${formatarData(doacao.dateCreated)}</div>
                `;
                container.appendChild(doacaoItem);
            });
        }

        async function carregarDoacoes() {
            const doacoesList = document.getElementById('donations-list');
            doacoesList.innerHTML = '<div class="donation-loading"><div class="spinner"></div><span>Carregando doações...</span></div>';

            try {
                const response = await fetch('https://dark-api-eta.vercel.app/api/donations');
                
                if (!response.ok) {
                    throw new Error('Erro ao carregar doações');
                }

                donationsData = await response.json();
                renderDonations();
            } catch (error) {
                console.error('Erro:', error);
                doacoesList.innerHTML = '<div class="donations-empty">Erro ao carregar doações. Tente novamente mais tarde.</div>';
            }
        }

        window.onload = function () {
            setTimeout(carregarDoacoes, 1500);
            setInterval(carregarDoacoes, 120000);

            loadCreditCards();
            AOS.init({
                duration: 800,
                easing: "ease",
                once: false,
                mirror: false,
            });

            const closeBtn = document.querySelector('.close-modal');
            closeBtn.addEventListener('click', closeUserModal);

            window.addEventListener('click', function (event) {
                const modal = document.getElementById('user-modal');
                if (event.target === modal) {
                    closeUserModal();
                }
            });

            document.addEventListener('keydown', function (event) {
                if (event.key === 'Escape') {
                    closeUserModal();
                }
            });

            document.querySelectorAll('.donations-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    switchTab(tab.dataset.tab);
                });
            });
        };
    </script>
</body>
</html>
